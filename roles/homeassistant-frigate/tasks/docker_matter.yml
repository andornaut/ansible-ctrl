---
- name: Resolve OTBR device path
  include_tasks: resolve_device.yml
  vars:
    device_paths: "{{ [homeassistantfrigate_otbr_device] if homeassistantfrigate_otbr_device.startswith('/') else [] }}"
    resolved_var_name: otbr_devices_resolved

- name: Remove Matter and OTBR containers if they exist
  community.docker.docker_container:
    name: "{{ item }}"
    state: absent
  loop:
    - matter
    - otbr
  ignore_errors: true

- name: Start Matter and Open Thread Border Router (OTBR) Docker containers
  vars:
    matter_base_volumes:
      - /run/dbus:/run/dbus:ro
      - "{{ homeassistantfrigate_matter_required_volumes.data }}:/data"
    matter_volumes: "{{ common_volumes + matter_base_volumes }}"

    otbr_base_volumes:
      - "{{ homeassistantfrigate_otbr_required_volumes.data }}:/data"
    otbr_volumes: "{{ common_volumes + otbr_base_volumes }}"

    # Build device list: always include /dev/net/tun, add physical device if present
    otbr_devices: "{{ ['/dev/net/tun'] + otbr_devices_resolved }}"

    otbr_base_env:
      - AUTOFLASH_FIRMWARE=0
      - BACKBONE_IF={{ homeassistantfrigate_otbr_backbone_if }}
      - BAUDRATE=460800
      # For network sockets: Use /tmp/ttyOTBR (pseudo-TTY created by socat service)
      # For physical devices: Use the resolved device path (e.g., /dev/ttyUSB0)
      - DEVICE={{ otbr_devices_resolved[0] if otbr_devices_resolved else '/tmp/ttyOTBR' }}
      - FIREWALL=1
      - FLOW_CONTROL=1
      - NAT64=1
      - OTBR_REST_PORT={{ homeassistantfrigate_otbr_rest_port }}
      - OTBR_WEB_PORT={{ homeassistantfrigate_otbr_web_port }}
    # Network socket configuration: NETWORK_DEVICE triggers socat to bridge TCP socket to /tmp/ttyOTBR
    otbr_network_env:
      - NETWORK_DEVICE={{ homeassistantfrigate_otbr_device }}
    otbr_env: "{{ otbr_base_env + (otbr_network_env if not otbr_devices_resolved else []) }}"

  community.docker.docker_compose_v2:
    project_name: homeassistantfrigate-matter
    pull: always
    remove_orphans: true
    definition:
      networks: "{{ external_network }}"
      services:
        matter:
          # http://matter.internal:5580
          container_name: matter
          hostname: matter-{{ ansible_hostname }}
          image: "{{ homeassistantfrigate_matter_docker_image }}"
          cap_add:
            - NET_ADMIN
            - NET_RAW
          logging: "{{ default_logging }}"
          ports:
            - "{{ homeassistantfrigate_matter_port }}:5580"
          restart: unless-stopped
          security_opt:
            - apparmor=unconfined # Needed for Bluetooth via dbus
          volumes: "{{ matter_volumes }}"
        otbr:
          # http://localhost:8080
          container_name: otbr
          hostname: otbr-{{ ansible_hostname }}
          image: "{{ homeassistantfrigate_otbr_docker_image }}"
          cap_add:
            - NET_ADMIN
            - NET_RAW
          devices: "{{ otbr_devices }}"
          environment: "{{ otbr_env }}"
          logging: "{{ default_logging }}"
          # Required for mDNS and physical interface access to work correctly
          network_mode: host
          restart: unless-stopped
          volumes: "{{ otbr_volumes }}"
  notify: update /etc/hosts
