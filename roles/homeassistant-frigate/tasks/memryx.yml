---
# See:
# https://github.com/blakeblackshear/frigate/blob/dev/docker/memryx/user_installation.sh
# https://developer.memryx.com/get_started/install_driver.html

- name: Unhold MemryX packages before removal
  ansible.builtin.dpkg_selections:
    name: "{{ item }}"
    selection: install
  loop:
    - memx-accl
    - memx-drivers
    - mxa-manager
  become: true
  ignore_errors: true

- name: Remove existing MemryX packages
  apt:
    name:
      - memx-*
      - mxa-manager
    state: absent
    purge: true
  become: true
  ignore_errors: true

- name: Remove existing MemryX repository files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/memryx.list
    - /etc/apt/trusted.gpg.d/memryx.asc
  become: true

- name: Install DKMS and kernel headers
  apt:
    name:
      - dkms
      - "linux-headers-{{ ansible_kernel }}"
    state: present
    update_cache: true
  become: true

- name: Add MemryX GPG key
  ansible.builtin.get_url:
    url: https://developer.memryx.com/deb/memryx.asc
    dest: /etc/apt/trusted.gpg.d/memryx.asc
    mode: "0644"
  become: true

- name: Add MemryX repository
  ansible.builtin.apt_repository:
    repo: "deb https://developer.memryx.com/deb stable main"
    filename: memryx
    state: present
  become: true

- name: Install MemryX SDK 2.1 packages
  apt:
    name:
      - memx-drivers=2.1.*
      - memx-accl=2.1.*
      - mxa-manager=2.1.*
    state: present
    update_cache: true
  become: true

- name: Hold MemryX packages to prevent automatic upgrades
  ansible.builtin.dpkg_selections:
    name: "{{ item }}"
    selection: hold
  loop:
    - memx-accl
    - memx-drivers
    - mxa-manager
  become: true

- name: Run ARM setup if on ARM architecture
  command: mx_arm_setup
  when: ansible_architecture in ['aarch64', 'arm64']
  become: true
  ignore_errors: true

- name: Notify user to restart system
  debug:
    msg: "MemryX drivers installed. A system restart is required to complete the installation."
