---
- name: Resolve device symlink paths to actual devices
  stat:
    path: "{{ item }}"
  register: device_stats_result
  loop: "{{ device_paths | default([]) }}"
  when: item.startswith('/dev/')

- name: "Set resolved device paths for {{ resolved_var_name }}"
  set_fact:
    "{{ resolved_var_name }}": "{{ resolved_devices }}"
  vars:
    resolved_devices: >-
      {%- set devices = [] -%}
      {%- for device in (device_paths | default([])) -%}
        {%- if device.startswith('/dev/') -%}
          {%- set device_stat = device_stats_result.results | selectattr('item', 'equalto', device) | first | default({}) -%}
          {%- if device_stat.stat is defined and device_stat.stat.islnk -%}
            {%- set target = device_stat.stat.lnk_target -%}
            {%- if target.startswith('/') -%}
              {%- set _ = devices.append(target) -%}
            {%- else -%}
              {%- set _ = devices.append('/dev/' + target.split('/')[-1]) -%}
            {%- endif -%}
          {%- else -%}
            {%- set _ = devices.append(device) -%}
          {%- endif -%}
        {%- else -%}
          {%- set _ = devices.append(device) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ devices }}

- name: "Resolved device path for {{ resolved_var_name }}"
  debug:
    msg: "{{ device_paths | default([]) }} -> {{ vars[resolved_var_name] }}"
