#!/bin/bash

set -euo nounset

[[ ${EUID} -eq 0 ]] || { echo 'Must be run as root'>&2; exit 1; }

RETENTION_NUMBER="{{ nas_backup_directories_retention }}"
RETRY_SECS=10
MOUNT_ONLY=false
UNMOUNT_ONLY=false
DEVICE_NAME=nasbackup
SOURCE_DIR="{{ nas_backup_directory }}"

case "${1:-}" in
    --mount-only)
        MOUNT_ONLY=true
        ;;
    --unmount)
        UNMOUNT_ONLY=true
        ;;
    "")
        ;;
    *)
        if [[ $# -eq 2 ]]; then
            DEVICE_NAME="${1}"
            SOURCE_DIR="${2}"
        else
            echo "Usage: $(basename "${0}") [--mount-only|--unmount] [deviceName sourceDir]">&2
            echo "  --mount-only: Only mount the device without starting backup">&2
            echo "  --unmount: Unmount and close the encrypted device">&2
            echo "  Example: $(basename "${0}") nasbackup /media/nas/backups">&2
            exit 1
        fi
        ;;
esac

[[ "${MOUNT_ONLY}" == "false" && "${UNMOUNT_ONLY}" == "false" && ! -d "${SOURCE_DIR}" ]] && { echo "\$SOURCE_DIR does not exist: ${SOURCE_DIR}">&2; exit 1; }

closeLuks() {
    local mount_dirs
    mount_dirs="$(findmnt -rno TARGET "/dev/mapper/${DEVICE_NAME}")" || true
    if [[ -n "${mount_dirs}" ]]; then
        echo "Unmounting: ${mount_dirs}"
        for dir in ${mount_dirs}; do
            umount "${dir}" || { sleep ${RETRY_SECS}; umount "${dir}"; }
        done
    fi
    cryptdisks_stop ${DEVICE_NAME}
}

[[ "${UNMOUNT_ONLY}" == "true" ]] && { closeLuks; echo "✓ Device unmounted and closed"; exit 0; }

# Mount via systemctl (handles LUKS unlocking via crypttab)
systemctl start "$(systemd-escape --path --suffix=mount "/dev/mapper/${DEVICE_NAME}")" || true
MOUNT_DIR="$(findmnt -rno TARGET "/dev/mapper/${DEVICE_NAME}" | head -1)"

[[ -z "${MOUNT_DIR}" ]] && { echo "Error: Could not derive mount directory">&2; exit 1; }

echo ""
echo "Device mounted: ${MOUNT_DIR}"
echo ""
echo "Manual commands:"
echo "  Mount:   systemctl start $(systemd-escape --path --suffix=mount "${MOUNT_DIR}")"
echo "  Unmount: umount ${MOUNT_DIR} && cryptdisks_stop ${DEVICE_NAME}"
echo ""

[[ "${MOUNT_ONLY}" == "true" ]] && exit 0

# Backup
DEST_DIR="${MOUNT_DIR}/rsnapshot.$(date -d @$(stat --format=%Y "${SOURCE_DIR}") +%Y-%m-%d)"
echo "Backup configuration:"
echo "  Source:      ${SOURCE_DIR}"
echo "  Destination: ${DEST_DIR}"
echo "  Retention:   ${RETENTION_NUMBER} backups"
echo ""

mkdir -p "${DEST_DIR}"

echo "→ Deleting backups older than the last ${RETENTION_NUMBER}..."
ls -1p "${MOUNT_DIR}" | grep -P '^rsnapshot\.\d{4}-\d{2}-\d{2}/$' | head -n-${RETENTION_NUMBER} | xargs -I {} rm -rf -- "${MOUNT_DIR}/{}"

echo "→ Starting backup..."
rsync --archive --delete --human-readable --info=progress2 "${SOURCE_DIR}" "${DEST_DIR}"
echo ""
echo "✓ Backup complete"
echo ""
tree -L 2 "${MOUNT_DIR}"
echo ""
closeLuks
